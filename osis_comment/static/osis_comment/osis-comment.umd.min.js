(function(s,l){typeof exports=="object"&&typeof module<"u"?l(require("@vue/runtime-dom"),require("vue-i18n"),require("vue")):typeof define=="function"&&define.amd?define(["@vue/runtime-dom","vue-i18n","vue"],l):(s=typeof globalThis<"u"?globalThis:s||self,l(s.Vue,s.VueI18n,s.Vue))})(this,function(s,l,t){"use strict";var ee=Object.defineProperty;var te=(s,l,t)=>l in s?ee(s,l,{enumerable:!0,configurable:!0,writable:!0,value:t}):s[l]=t;var m=(s,l,t)=>(te(s,typeof l!="symbol"?l+"":l,t),t);const C={en:{thread:{title:"Comments",add_comment:"Add comment",previous:"Previous page",next:"Next page",sort:"sort"},entry:{anonymous:"Anonymous",authored_date:"on {date} at {time}",edit_comment:"Edit",submit_comment:"Submit",delete_comment:"Delete",cancel_edit:"Annuler",placeholder:"Your comment"},error:"Error: {error}",request_error:"Request error: {error}"},"fr-be":{thread:{title:"Commentaires",add_comment:"Ajouter un commentaire",previous:"Page précédente",next:"Page suivante",sort:"trier"},entry:{anonymous:"Anonyme",authored_date:"le {date} à {time}",edit_comment:"Modifier",submit_comment:"Soumettre",delete_comment:"Supprimer",cancel_edit:"Annuler",placeholder:"Votre commentaire"},error:"Erreur: {error}",request_error:"Erreur HTTP: {error}"}},$=l.createI18n({locale:document.documentElement.lang||"en",messages:C});class y{constructor({uuid:n,comment:o,author:r,tags:i,extra_data:c,links:d,created_at:a}){m(this,"uuid");m(this,"comment");m(this,"author");m(this,"tags");m(this,"extra_data");m(this,"links");m(this,"created_at");this.uuid=n,this.comment=o,this.author=r,this.tags=i,this.extra_data=c,this.links=d,this.created_at=new Date(a)}}/**
 * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md.
 */function b(e,n,o){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("script");typeof n=="function"&&(o=n,n={}),n=n||{},o=o||function(){},i.type=n.type||"text/javascript",i.charset=n.charset||"utf8",i.async="async"in n?!!n.async:!0,i.src=e,n.attrs&&S(i,n.attrs),n.text&&(i.text=String(n.text));var c="onload"in i?g:T;c(i,o),i.onload||g(i,o),r.appendChild(i)}function S(e,n){for(var o in n)e.setAttribute(o,n[o])}function g(e,n){e.onload=function(){this.onerror=this.onload=null,n(null,e)},e.onerror=function(){this.onerror=this.onload=null,n(new Error("Failed to load "+this.src),e)}}function T(e,n){e.onreadystatechange=function(){this.readyState!="complete"&&this.readyState!="loaded"||(this.onreadystatechange=null,n(null,e))}}var p;function h(e,n){return"CKEDITOR"in window?Promise.resolve(CKEDITOR):typeof e!="string"||e.length<1?Promise.reject(new TypeError("CKEditor URL must be a non-empty string.")):(p||(p=h.scriptLoader(e).then(function(o){return n&&n(o),o})),p)}h.scriptLoader=function(e){return new Promise(function(n,o){b(e,function(r){if(p=void 0,r)return o(r);if(!window.CKEDITOR)return o(new Error("Script loaded from editorUrl doesn't provide CKEDITOR namespace."));n(CKEDITOR)})})};function B(e,n){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r;return function(){clearTimeout(r);for(var i=arguments.length,c=new Array(i),d=0;d<i;d++)c[d]=arguments[d];r=setTimeout(e.bind.apply(e,[o].concat(c)),n)}}const V={name:"ckeditor",render(){return t.h("div",{},[t.h(this.tagName)])},props:{modelValue:{type:String,default:""},type:{type:String,default:"classic",validator:e=>["classic","inline"].includes(e)},editorUrl:{type:String,default:"https://cdn.ckeditor.com/4.17.2/standard-all/ckeditor.js"},config:{type:Object,default:()=>{}},tagName:{type:String,default:"textarea"},readOnly:{type:Boolean,default:null},throttle:{type:Number,default:80}},mounted(){h(this.editorUrl,e=>{this.$emit("namespaceloaded",e)}).then(()=>{if(this.$_destroyed)return;const e=this.prepareConfig(),n=this.type==="inline"?"inline":"replace",o=this.$el.firstElementChild;CKEDITOR[n](o,e)})},data(){return{readyEmitted:!1}},beforeDestroy(){this.instance&&this.instance.destroy(),this.$_destroyed=!0},watch:{modelValue(e){this.instance&&this.instance.getData()!==e&&this.instance.setData(e)},readOnly(e){this.instance&&this.instance.setReadOnly(e)}},methods:{prepareConfig(){const e=this.config||{};e.on=e.on||{},e.delayIfDetached===void 0&&(e.delayIfDetached=!0),this.readOnly!==null&&(e.readOnly=this.readOnly);const n=e.on.instanceReady;return e.on.instanceReady=o=>{this.instance=o.editor,this.$nextTick().then(()=>{this.prepareComponentData(),n&&n(o)})},e},prepareComponentData(){const e=this.modelValue;this.instance.fire("lockSnapshot"),this.instance.setData(e,{callback:()=>{this.$_setUpEditorEvents();const n=this.instance.getData();e!==n?(this.readyEmitted||(this.$emit("ready",this.instance),console.log("Emitting Ready"),this.readyEmitted=!0),this.$emit("update:modelValue",n)):this.readyEmitted||(this.$emit("ready",this.instance),console.log("Emitting Ready"),this.readyEmitted=!0),this.instance.fire("unlockSnapshot")}})},$_setUpEditorEvents(){const e=this.instance,n=B(o=>{const r=e.getData();this.modelValue!==r&&this.$emit("update:modelValue",r,o,e)},this.throttle);e.on("change",n),e.on("focus",o=>{this.$emit("focus",o,e)}),e.on("blur",o=>{this.$emit("blur",o,e)})}}},N=t.defineComponent({name:"CommentEditor",components:{ckeditor:V},props:{richTextConfig:{type:Object,default:()=>{}},defaultValue:{type:String,default:""}},emits:["cancel","submit"],data:function(){return{value:this.defaultValue}}}),f=(e,n)=>{const o=e.__vccOpts||e;for(const[r,i]of n)o[r]=i;return o},D=["placeholder"],w={class:"text-right"};function P(e,n,o,r,i,c){const d=t.resolveComponent("ckeditor");return t.openBlock(),t.createElementBlock("div",null,[e.richTextConfig?(t.openBlock(),t.createBlock(d,{key:1,modelValue:e.value,"onUpdate:modelValue":n[1]||(n[1]=a=>e.value=a),config:e.richTextConfig},null,8,["modelValue","config"])):t.withDirectives((t.openBlock(),t.createElementBlock("textarea",{key:0,"onUpdate:modelValue":n[0]||(n[0]=a=>e.value=a),class:"form-control",placeholder:e.$t("entry.placeholder")},null,8,D)),[[t.vModelText,e.value]]),t.createElementVNode("div",w,[t.createElementVNode("button",{class:"btn btn-sm btn-success",onClick:n[2]||(n[2]=a=>e.$emit("submit",e.value))},t.toDisplayString(e.$t("entry.submit_comment")),1),t.createElementVNode("button",{class:"btn btn-sm btn-default",onClick:n[3]||(n[3]=a=>e.$emit("cancel"))},t.toDisplayString(e.$t("entry.cancel_edit")),1)])])}const E=f(N,[["render",P]]),O=t.defineComponent({name:"CommentEntry",components:{CommentEditor:E},props:{richTextConfig:{type:Object,default:()=>{}},entry:{type:y,required:!0}},emits:["edit","delete"],data:function(){return{isEditing:!1}}}),ne="",A={class:"panel-body clearfix"},_={class:"comment-authoring"},U={class:"pull-right comment-actions"},R=["title"],q=[t.createElementVNode("i",{class:"fas fa-pencil"},null,-1)],I=["title"],L=[t.createElementVNode("i",{class:"fas fa-trash-alt"},null,-1)],j={key:0,class:"comment-content"},M=["innerHTML"],z=["innerHTML"];function K(e,n,o,r,i,c){const d=t.resolveComponent("CommentEditor");return t.openBlock(),t.createElementBlock("div",A,[t.createElementVNode("div",_,[t.createElementVNode("strong",null,t.toDisplayString(e.entry.author||e.$t("entry.anonymous")),1),t.createTextVNode(" "+t.toDisplayString(e.$t("entry.authored_date",{date:e.entry.created_at.toLocaleDateString(),time:e.entry.created_at.toLocaleTimeString()})),1)]),e.isEditing?(t.openBlock(),t.createBlock(d,{key:1,"default-value":e.entry.comment,"rich-text-config":e.richTextConfig,onSubmit:n[2]||(n[2]=a=>e.$emit("edit",e.entry.links.edit,a)),onCancel:n[3]||(n[3]=a=>e.isEditing=!1)},null,8,["default-value","rich-text-config"])):(t.openBlock(),t.createElementBlock(t.Fragment,{key:0},[t.createElementVNode("div",U,[typeof e.entry.links.edit=="string"?(t.openBlock(),t.createElementBlock("button",{key:0,class:"btn btn-sm btn-default",title:e.$t("entry.edit_comment"),onClick:n[0]||(n[0]=a=>e.isEditing=!0)},q,8,R)):t.createCommentVNode("",!0),typeof e.entry.links.delete=="string"?(t.openBlock(),t.createElementBlock("button",{key:1,class:"btn btn-sm btn-danger",title:e.$t("entry.delete_comment"),onClick:n[1]||(n[1]=a=>e.$emit("delete",e.entry.links.delete))},L,8,I)):t.createCommentVNode("",!0)]),e.richTextConfig?(t.openBlock(),t.createElementBlock("div",{key:1,class:"comment-content",innerHTML:e.entry.comment},null,8,z)):(t.openBlock(),t.createElementBlock("div",j,[t.createElementVNode("p",{innerHTML:e.entry.comment.replace(/\n/g,"<br/>")},null,8,M)]))],64))])}const H=f(O,[["render",K]]),F=t.defineComponent({name:"CommentThread",components:{CommentEditor:E,CommentEntry:H},props:{url:{type:String,required:!0},tags:{type:Array,default:()=>[]},headerTitle:{type:String,default:""},pageSize:{type:Number,default:10},defaultSort:{type:String,default:"-created"},panelClass:{type:String,default:"default"},richTextConfig:{type:Object,default:()=>{}}},data(){const e=new URLSearchParams({limit:String(this.pageSize),sort:"-created"});this.tags.length&&e.append("tags",this.tags.join(","));const n=document.querySelector("[name=csrfmiddlewaretoken]");if(!(n instanceof HTMLInputElement))throw new Error("Please include {% csrf_token %} in your page.");return{entries:[],error:"",createUrl:null,currentUrl:`${this.url}?${e.toString()}`,currentSort:"-created",previousPage:null,nextPage:null,loading:!0,isAdding:!1,csrfToken:n.value}},computed:{isAscendedSort:function(){return this.currentSort==="created"}},mounted(){this.loadEntries()},methods:{async changeSort(){const e=new URL(window.location.origin+this.currentUrl),n=new URLSearchParams(e.search);this.currentSort=this.isAscendedSort?"-created":"created",n.set("sort",this.currentSort),this.currentUrl=`${e.pathname}?${n.toString()}`,await this.loadEntries()},async loadEntries(){const e=await this.doRequest(this.currentUrl,{},!1);e&&(this.createUrl=typeof e.create=="string"?e.create:null,this.previousPage=e.previous,this.nextPage=e.next,this.entries=e.results.map(n=>new y(n)))},async createEntry(e){await this.doRequest(this.createUrl,{method:"POST",body:JSON.stringify({comment:e,tags:this.tags})}),this.isAdding=!1},async editEntry(e,n){await this.doRequest(e,{method:"PUT",body:JSON.stringify({comment:n})})},async deleteEntry(e){await this.doRequest(e,{method:"DELETE"})},async doRequest(e,n,o=!0){this.loading=!0;try{const r=await fetch(e,{mode:"same-origin",headers:{"Content-Type":"application/json;charset=utf-8","X-CSRFToken":this.csrfToken},...n});if(r.status>=200&&r.status<300)return o&&await this.loadEntries(),this.loading=!1,r.json();this.error=r.statusText}catch(r){this.error=r.message}this.loading=!1}}}),ie="",J={class:"panel-heading clearfix"},X={key:0,class:"spinner"},Y={key:1,class:"panel-body text-danger"},G={key:3,class:"panel-body"},Q=t.createElementVNode("i",{class:"fas fa-chevron-left"},null,-1),W=t.createElementVNode("i",{class:"fas fa-chevron-right"},null,-1),Z=t.createElementVNode("i",{class:"fas fa-plus"},null,-1);function v(e,n,o,r,i,c){const d=t.resolveComponent("CommentEntry"),a=t.resolveComponent("CommentEditor");return t.openBlock(),t.createElementBlock("div",{class:t.normalizeClass(["comment-thread panel",`panel-${e.panelClass}`])},[t.createElementVNode("div",J,[t.createTextVNode(t.toDisplayString(e.headerTitle||e.$t("thread.title"))+" ",1),t.createElementVNode("button",{class:"btn btn-default btn-sm pull-right",onClick:n[0]||(n[0]=u=>e.changeSort())},[t.createTextVNode(t.toDisplayString(e.$t("thread.sort"))+" ",1),t.createElementVNode("i",{class:t.normalizeClass(["fas",e.isAscendedSort?"fa-sort-up":"fa-sort-down"])},null,2)])]),e.loading?(t.openBlock(),t.createElementBlock("span",X)):e.error?(t.openBlock(),t.createElementBlock("div",Y,t.toDisplayString(e.error),1)):(t.openBlock(!0),t.createElementBlock(t.Fragment,{key:2},t.renderList(e.entries,u=>(t.openBlock(),t.createBlock(d,{key:u.uuid,entry:u,onEdit:e.editEntry,onDelete:e.deleteEntry},null,8,["entry","onEdit","onDelete"]))),128)),e.nextPage||e.previousPage||e.createUrl?(t.openBlock(),t.createElementBlock("div",G,[e.previousPage?(t.openBlock(),t.createElementBlock("button",{key:0,class:"btn btn-sm btn-default",onClick:n[1]||(n[1]=u=>{e.previousPage&&(e.currentUrl=e.previousPage),e.loadEntries()})},[Q,t.createTextVNode(" "+t.toDisplayString(e.$t("thread.previous")),1)])):t.createCommentVNode("",!0),e.nextPage?(t.openBlock(),t.createElementBlock("button",{key:1,class:"btn btn-sm btn-default",onClick:n[2]||(n[2]=u=>{e.nextPage&&(e.currentUrl=e.nextPage),e.loadEntries()})},[t.createTextVNode(t.toDisplayString(e.$t("thread.next"))+" ",1),W])):t.createCommentVNode("",!0),e.createUrl?(t.openBlock(),t.createElementBlock(t.Fragment,{key:2},[e.isAdding?(t.openBlock(),t.createBlock(a,{key:1,"rich-text-config":e.richTextConfig,onSubmit:e.createEntry,onCancel:n[4]||(n[4]=u=>e.isAdding=!e.isAdding)},null,8,["rich-text-config","onSubmit"])):(t.openBlock(),t.createElementBlock("button",{key:0,class:"btn btn-sm btn-primary pull-right",onClick:n[3]||(n[3]=u=>e.isAdding=!e.isAdding)},[Z,t.createTextVNode(" "+t.toDisplayString(e.$t("thread.add_comment")),1)]))],64)):t.createCommentVNode("",!0)])):t.createCommentVNode("",!0)],2)}const x=f(F,[["render",v]]);function k(){document.querySelectorAll(".comment-viewer:not([data-v-app])").forEach(e=>{const n={url:"",...e.dataset};typeof e.dataset.pageSize<"u"&&(n.pageSize=Number.parseInt(e.dataset.pageSize)),typeof e.dataset.tags<"u"&&(n.tags=e.dataset.tags.split(",")),s.createApp(x,n).use($).mount(e)})}k(),new MutationObserver(k).observe(document,{childList:!0,subtree:!0})});
//# sourceMappingURL=osis-comment.umd.min.js.map
