(function(a,l){typeof exports=="object"&&typeof module<"u"?l(require("@vue/runtime-dom"),require("vue-i18n"),require("vue")):typeof define=="function"&&define.amd?define(["@vue/runtime-dom","vue-i18n","vue"],l):(a=typeof globalThis<"u"?globalThis:a||self,l(a.Vue,a.VueI18n,a.Vue))})(this,function(a,l,n){"use strict";var le=Object.defineProperty;var de=(a,l,n)=>l in a?le(a,l,{enumerable:!0,configurable:!0,writable:!0,value:n}):a[l]=n;var u=(a,l,n)=>(de(a,typeof l!="symbol"?l+"":l,n),n);const _={thread:{title:e=>{const{normalize:t}=e;return t(["Comments"])},add_comment:e=>{const{normalize:t}=e;return t(["Add"])},previous:e=>{const{normalize:t}=e;return t(["Previous page"])},next:e=>{const{normalize:t}=e;return t(["Next page"])},sort:e=>{const{normalize:t}=e;return t(["sort"])}},entry:{anonymous:e=>{const{normalize:t}=e;return t(["Anonymous"])},authored_date:e=>{const{normalize:t,interpolate:o,named:r}=e;return t(["on ",o(r("date"))," at ",o(r("time"))])},edit_comment:e=>{const{normalize:t}=e;return t(["Edit"])},last_update_by:e=>{const{normalize:t}=e;return t(["Last update by"])},save_comment:e=>{const{normalize:t}=e;return t(["Save"])},delete_comment:e=>{const{normalize:t}=e;return t(["Delete"])},cancel_edit:e=>{const{normalize:t}=e;return t(["Annuler"])},placeholder:e=>{const{normalize:t}=e;return t(["Your comment"])}},error:e=>{const{normalize:t,interpolate:o,named:r}=e;return t(["Error: ",o(r("error"))])},request_error:e=>{const{normalize:t,interpolate:o,named:r}=e;return t(["Request error: ",o(r("error"))])}},$={thread:{title:e=>{const{normalize:t}=e;return t(["Commentaires"])},add_comment:e=>{const{normalize:t}=e;return t(["Ajouter"])},previous:e=>{const{normalize:t}=e;return t(["Page précédente"])},next:e=>{const{normalize:t}=e;return t(["Page suivante"])},sort:e=>{const{normalize:t}=e;return t(["trier"])}},entry:{anonymous:e=>{const{normalize:t}=e;return t(["Anonyme"])},authored_date:e=>{const{normalize:t,interpolate:o,named:r}=e;return t(["le ",o(r("date"))," à ",o(r("time"))])},edit_comment:e=>{const{normalize:t}=e;return t(["Modifier"])},last_update_by:e=>{const{normalize:t}=e;return t(["Dernière mise à jour par"])},save_comment:e=>{const{normalize:t}=e;return t(["Enregistrer"])},delete_comment:e=>{const{normalize:t}=e;return t(["Supprimer"])},cancel_edit:e=>{const{normalize:t}=e;return t(["Annuler"])},placeholder:e=>{const{normalize:t}=e;return t(["Votre commentaire"])}},error:e=>{const{normalize:t,interpolate:o,named:r}=e;return t(["Erreur: ",o(r("error"))])},request_error:e=>{const{normalize:t,interpolate:o,named:r}=e;return t(["Erreur HTTP: ",o(r("error"))])}},b=l.createI18n({locale:document.documentElement.lang||"en",messages:{en:_,fr:$}});class y{constructor({uuid:t,comment:o,author:r,tags:i,extra_data:c,links:d,created_at:s,modified_at:m}){u(this,"uuid");u(this,"comment");u(this,"author");u(this,"tags");u(this,"extra_data");u(this,"links");u(this,"created_at");u(this,"modified_at");this.uuid=t,this.comment=o,this.author=r,this.tags=i,this.extra_data=c,this.links=d,this.created_at=new Date(s),this.modified_at=new Date(m)}}/**
 * @license Copyright (c) 2003-2021, CKSource - Frederico Knabben. All rights reserved.
 * For licensing, see LICENSE.md.
 */function S(e,t,o){var r=document.head||document.getElementsByTagName("head")[0],i=document.createElement("script");typeof t=="function"&&(o=t,t={}),t=t||{},o=o||function(){},i.type=t.type||"text/javascript",i.charset=t.charset||"utf8",i.async="async"in t?!!t.async:!0,i.src=e,t.attrs&&z(i,t.attrs),t.text&&(i.text=String(t.text));var c="onload"in i?g:B;c(i,o),i.onload||g(i,o),r.appendChild(i)}function z(e,t){for(var o in t)e.setAttribute(o,t[o])}function g(e,t){e.onload=function(){this.onerror=this.onload=null,t(null,e)},e.onerror=function(){this.onerror=this.onload=null,t(new Error("Failed to load "+this.src),e)}}function B(e,t){e.onreadystatechange=function(){this.readyState!="complete"&&this.readyState!="loaded"||(this.onreadystatechange=null,t(null,e))}}var p;function h(e,t){return"CKEDITOR"in window?Promise.resolve(CKEDITOR):typeof e!="string"||e.length<1?Promise.reject(new TypeError("CKEditor URL must be a non-empty string.")):(p||(p=h.scriptLoader(e).then(function(o){return t&&t(o),o})),p)}h.scriptLoader=function(e){return new Promise(function(t,o){S(e,function(r){if(p=void 0,r)return o(r);if(!window.CKEDITOR)return o(new Error("Script loaded from editorUrl doesn't provide CKEDITOR namespace."));t(CKEDITOR)})})};function T(e,t){var o=arguments.length>2&&arguments[2]!==void 0?arguments[2]:{},r;return function(){clearTimeout(r);for(var i=arguments.length,c=new Array(i),d=0;d<i;d++)c[d]=arguments[d];r=setTimeout(e.bind.apply(e,[o].concat(c)),t)}}const V={name:"ckeditor",render(){return n.h("div",{},[n.h(this.tagName)])},props:{modelValue:{type:String,default:""},type:{type:String,default:"classic",validator:e=>["classic","inline"].includes(e)},editorUrl:{type:String,default:"https://cdn.ckeditor.com/4.17.2/standard-all/ckeditor.js"},config:{type:Object,default:()=>{}},tagName:{type:String,default:"textarea"},readOnly:{type:Boolean,default:null},throttle:{type:Number,default:80}},mounted(){h(this.editorUrl,e=>{this.$emit("namespaceloaded",e)}).then(()=>{if(this.$_destroyed)return;const e=this.prepareConfig(),t=this.type==="inline"?"inline":"replace",o=this.$el.firstElementChild;CKEDITOR[t](o,e)})},data(){return{readyEmitted:!1}},beforeDestroy(){this.instance&&this.instance.destroy(),this.$_destroyed=!0},watch:{modelValue(e){this.instance&&this.instance.getData()!==e&&this.instance.setData(e)},readOnly(e){this.instance&&this.instance.setReadOnly(e)}},methods:{prepareConfig(){const e=this.config||{};e.on=e.on||{},e.delayIfDetached===void 0&&(e.delayIfDetached=!0),this.readOnly!==null&&(e.readOnly=this.readOnly);const t=e.on.instanceReady;return e.on.instanceReady=o=>{this.instance=o.editor,this.$nextTick().then(()=>{this.prepareComponentData(),t&&t(o)})},e},prepareComponentData(){const e=this.modelValue;this.instance.fire("lockSnapshot"),this.instance.setData(e,{callback:()=>{this.$_setUpEditorEvents();const t=this.instance.getData();e!==t?(this.readyEmitted||(this.$emit("ready",this.instance),console.log("Emitting Ready"),this.readyEmitted=!0),this.$emit("update:modelValue",t)):this.readyEmitted||(this.$emit("ready",this.instance),console.log("Emitting Ready"),this.readyEmitted=!0),this.instance.fire("unlockSnapshot")}})},$_setUpEditorEvents(){const e=this.instance,t=T(o=>{const r=e.getData();this.modelValue!==r&&this.$emit("update:modelValue",r,o,e)},this.throttle);e.on("change",t),e.on("focus",o=>{this.$emit("focus",o,e)}),e.on("blur",o=>{this.$emit("blur",o,e)})}}},w=n.defineComponent({name:"CommentEditor",components:{ckeditor:V},props:{richTextConfig:{type:Object,default:()=>{}},defaultValue:{type:String,default:""}},emits:["cancel","submit"],data:function(){return{value:this.defaultValue}}}),ce="",f=(e,t)=>{const o=e.__vccOpts||e;for(const[r,i]of t)o[r]=i;return o},N=["placeholder"],D={class:"text-right text-end btn-actions"};function O(e,t,o,r,i,c){const d=n.resolveComponent("ckeditor");return n.openBlock(),n.createElementBlock("div",null,[e.richTextConfig?(n.openBlock(),n.createBlock(d,{key:1,modelValue:e.value,"onUpdate:modelValue":t[1]||(t[1]=s=>e.value=s),config:e.richTextConfig},null,8,["modelValue","config"])):n.withDirectives((n.openBlock(),n.createElementBlock("textarea",{key:0,"onUpdate:modelValue":t[0]||(t[0]=s=>e.value=s),class:"form-control",placeholder:e.$t("entry.placeholder")},null,8,N)),[[n.vModelText,e.value]]),n.createElementVNode("div",D,[n.createElementVNode("button",{class:"btn btn-sm p-2 btn-primary fs-7",onClick:t[2]||(t[2]=s=>e.$emit("submit",e.value))},n.toDisplayString(e.$t("entry.save_comment")),1),n.createElementVNode("button",{class:"btn btn-sm p-2 btn-default fs-7",onClick:t[3]||(t[3]=s=>e.$emit("cancel"))},n.toDisplayString(e.$t("entry.cancel_edit")),1)])])}const E=f(w,[["render",O]]),P=n.defineComponent({name:"CommentEntry",components:{CommentEditor:E},props:{richTextConfig:{type:Object,default:()=>{}},entry:{type:y,required:!0},withLastUpdateByPrefix:{type:Boolean,default:()=>!1}},emits:["edit","delete"],data:function(){return{isEditing:!1}}}),me="",A={class:"panel-body card-body pb-0 clearfix"},R={class:"comment-authoring"},U={key:0},M={class:"pull-right float-end comment-actions"},q=["title"],L=[n.createElementVNode("i",{class:"fas fa-pencil fs-6"},null,-1)],j=["title"],I=[n.createElementVNode("i",{class:"fas fa-times fs-6"},null,-1)],F={key:0,class:"comment-content pb-0"},H=["innerHTML"],K=["innerHTML"];function J(e,t,o,r,i,c){const d=n.resolveComponent("CommentEditor");return n.openBlock(),n.createElementBlock("div",A,[n.createElementVNode("div",R,[e.withLastUpdateByPrefix?(n.openBlock(),n.createElementBlock("span",U,n.toDisplayString(e.$t("entry.last_update_by")+" "),1)):n.createCommentVNode("",!0),n.createElementVNode("strong",null,n.toDisplayString(e.entry.author||e.$t("entry.anonymous")),1),n.createTextVNode(" "+n.toDisplayString(e.$t("entry.authored_date",{date:e.entry.modified_at.toLocaleDateString(e.$i18n.locale),time:e.entry.modified_at.toLocaleTimeString()})),1)]),e.isEditing?(n.openBlock(),n.createBlock(d,{key:1,"default-value":e.entry.comment,"rich-text-config":e.richTextConfig,onSubmit:t[2]||(t[2]=s=>e.$emit("edit",e.entry.links.edit,s,()=>e.isEditing=!1)),onCancel:t[3]||(t[3]=s=>e.isEditing=!1)},null,8,["default-value","rich-text-config"])):(n.openBlock(),n.createElementBlock(n.Fragment,{key:0},[n.createElementVNode("div",M,[typeof e.entry.links.edit=="string"?(n.openBlock(),n.createElementBlock("button",{key:0,class:"btn btn-sm btn-primary",title:e.$t("entry.edit_comment"),onClick:t[0]||(t[0]=s=>e.isEditing=!0)},L,8,q)):n.createCommentVNode("",!0),typeof e.entry.links.delete=="string"?(n.openBlock(),n.createElementBlock("button",{key:1,class:"btn btn-sm btn-danger",title:e.$t("entry.delete_comment"),onClick:t[1]||(t[1]=s=>e.$emit("delete",e.entry.links.delete))},I,8,j)):n.createCommentVNode("",!0)]),e.richTextConfig?(n.openBlock(),n.createElementBlock("div",{key:1,class:"comment-content",innerHTML:e.entry.comment},null,8,K)):(n.openBlock(),n.createElementBlock("div",F,[n.createElementVNode("p",{innerHTML:e.entry.comment.replace(/\n/g,"<br/>")},null,8,H)]))],64))])}const X=f(P,[["render",J]]);function Y(e){return{all:e=e||new Map,on:function(t,o){var r=e.get(t);r?r.push(o):e.set(t,[o])},off:function(t,o){var r=e.get(t);r&&(o?r.splice(r.indexOf(o)>>>0,1):e.set(t,[]))},emit:function(t,o){var r=e.get(t);r&&r.slice().map(function(i){i(o)}),(r=e.get("*"))&&r.slice().map(function(i){i(t,o)})}}}const k=Y(),G=n.defineComponent({name:"CommentViewer",components:{CommentEditor:E,CommentEntry:X},props:{url:{type:String,required:!0},tags:{type:Array,default:()=>[]},headerTitle:{type:String,default:""},pageSize:{type:Number,default:10},defaultSort:{type:String,default:"-modified_at"},panelClass:{type:String,default:"default"},richTextConfig:{type:Object,default:()=>{}},singleMode:{type:Boolean,default:!0}},data(){const e=new URLSearchParams(this.singleMode?{last:"1"}:{limit:String(this.pageSize),sort:"-modified_at"});this.tags.length&&e.append("tags",this.tags.join(","));const t=document.querySelector("[name=csrfmiddlewaretoken]");if(!(t instanceof HTMLInputElement))throw new Error("Please include {% csrf_token %} in your page.");return{entries:[],error:"",total:null,createUrl:null,currentUrl:`${this.url}?${e.toString()}`,currentSort:"-modified_at",previousPage:null,nextPage:null,loading:!0,isAdding:!1,csrfToken:t.value}},computed:{isAscendedSort:function(){return this.currentSort==="modified_at"}},mounted(){this.loadEntries()},methods:{async changeSort(){const e=new URL(window.location.origin+this.currentUrl),t=new URLSearchParams(e.search);this.currentSort=this.isAscendedSort?"-modified_at":"modified_at",t.set("sort",this.currentSort),this.currentUrl=`${e.pathname}?${t.toString()}`,await this.loadEntries()},async loadEntries(){const e=await this.doRequest(this.currentUrl,{},!1);e&&(this.createUrl=typeof e.create=="string"&&(!this.singleMode||e.results.length===0)?e.create:null,this.previousPage=e.previous,this.nextPage=e.next,this.total=e.count,this.entries=e.results.map(t=>new y(t)))},async createEntry(e){await this.doRequest(this.createUrl,{method:"POST",body:JSON.stringify({comment:e,tags:this.tags})}),this.isAdding=!1},async editEntry(e,t,o){await this.doRequest(e,{method:"PUT",body:JSON.stringify({comment:t})}).then(o)},async deleteEntry(e){await this.doRequest(e,{method:"DELETE"})},async doRequest(e,t,o=!0){this.loading=!0,this.error="";try{const r=await fetch(e,{mode:"same-origin",headers:{"Content-Type":"application/json;charset=utf-8","X-CSRFToken":this.csrfToken},...t});if(r.status>=200&&r.status<300)return o&&(await this.loadEntries(),k.emit("REFRESH_COMMENTS_EVENT")),this.loading=!1,r.json();this.error=r.statusText}catch(r){this.error=r.message}this.loading=!1}}}),fe="",Q={class:"panel-heading clearfix bg-primary text-white"},W={key:0,class:"spinner"},Z={key:1,class:"panel-body card-body pb-0 text-danger"},v={key:3,class:"panel-body card-body pb-3"},x=n.createElementVNode("i",{class:"fas fa-chevron-left"},null,-1),ee=n.createElementVNode("i",{class:"fas fa-chevron-right"},null,-1),te=n.createElementVNode("i",{class:"fas fa-plus"},null,-1);function ne(e,t,o,r,i,c){const d=n.resolveComponent("CommentEntry"),s=n.resolveComponent("CommentEditor");return n.openBlock(),n.createElementBlock("div",{class:n.normalizeClass(["comment-panel panel border border-primary mb-4 rounded-top d-flex flex-column",`panel-${e.panelClass} card-${e.panelClass}`])},[n.createElementVNode("div",Q,[n.createTextVNode(n.toDisplayString(e.headerTitle||e.$t("thread.title"))+" ",1),e.total!=null&&!e.singleMode?(n.openBlock(),n.createElementBlock(n.Fragment,{key:0},[n.createTextVNode(" ("+n.toDisplayString(e.total)+") ",1)],64)):n.createCommentVNode("",!0),e.singleMode?n.createCommentVNode("",!0):(n.openBlock(),n.createElementBlock("button",{key:1,class:"btn btn-default p-2 px-3 btn-sm pull-right float-end",onClick:t[0]||(t[0]=m=>e.changeSort())},[n.createTextVNode(n.toDisplayString(e.$t("thread.sort"))+" ",1),n.createElementVNode("i",{class:n.normalizeClass(["fas",e.isAscendedSort?"fa-sort-up":"fa-sort-down"])},null,2)]))]),e.loading?(n.openBlock(),n.createElementBlock("span",W)):n.createCommentVNode("",!0),e.error?(n.openBlock(),n.createElementBlock("div",Z,n.toDisplayString(e.error),1)):(n.openBlock(!0),n.createElementBlock(n.Fragment,{key:2},n.renderList(e.entries,m=>(n.openBlock(),n.createBlock(d,{key:m.uuid,entry:m,"rich-text-config":e.richTextConfig,"with-last-update-by-prefix":e.singleMode,onEdit:e.editEntry,onDelete:e.deleteEntry},null,8,["entry","rich-text-config","with-last-update-by-prefix","onEdit","onDelete"]))),128)),e.nextPage||e.previousPage||e.createUrl?(n.openBlock(),n.createElementBlock("div",v,[e.previousPage&&!e.singleMode?(n.openBlock(),n.createElementBlock("button",{key:0,class:"btn btn-sm btn-default",onClick:t[1]||(t[1]=m=>{e.previousPage&&(e.currentUrl=e.previousPage),e.loadEntries()})},[x,n.createTextVNode(" "+n.toDisplayString(e.$t("thread.previous")),1)])):n.createCommentVNode("",!0),e.nextPage&&!e.singleMode?(n.openBlock(),n.createElementBlock("button",{key:1,class:"btn btn-sm btn-default",onClick:t[2]||(t[2]=m=>{e.nextPage&&(e.currentUrl=e.nextPage),e.loadEntries()})},[n.createTextVNode(n.toDisplayString(e.$t("thread.next"))+" ",1),ee])):n.createCommentVNode("",!0),e.createUrl?(n.openBlock(),n.createElementBlock(n.Fragment,{key:2},[e.isAdding?(n.openBlock(),n.createBlock(s,{key:1,"rich-text-config":e.richTextConfig,onSubmit:e.createEntry,onCancel:t[4]||(t[4]=m=>e.isAdding=!e.isAdding)},null,8,["rich-text-config","onSubmit"])):(n.openBlock(),n.createElementBlock("button",{key:0,class:"btn btn-sm p-2 btn-primary pull-right float-end fs-7",onClick:t[3]||(t[3]=m=>e.isAdding=!e.isAdding)},[te,n.createTextVNode(" "+n.toDisplayString(e.$t("thread.add_comment")),1)]))],64)):n.createCommentVNode("",!0)])):n.createCommentVNode("",!0)],2)}const oe=f(G,[["render",ne]]),re=n.defineComponent({name:"CommentCount",props:{url:{type:String,required:!0}},data:function(){return{value:null,loading:!0,error:""}},mounted(){this.loadCount(),k.on("REFRESH_COMMENTS_EVENT",()=>void this.loadCount())},methods:{async loadCount(){const t=await(await fetch(this.url,{mode:"same-origin",headers:{"Content-Type":"application/json;charset=utf-8"}})).json();this.value=t.count}}}),he="",ie={key:0,class:"badge badge-compteur"};function ae(e,t,o,r,i,c){return e.value!=0?(n.openBlock(),n.createElementBlock("div",ie,n.toDisplayString(e.value),1)):n.createCommentVNode("",!0)}const se=f(re,[["render",ae]]);function C(){document.querySelectorAll(".comment-viewer:not([data-v-app]), .comment-thread-viewer:not([data-v-app])").forEach(e=>{const t={url:"",...e.dataset};typeof e.dataset.pageSize<"u"&&(t.pageSize=Number.parseInt(e.dataset.pageSize)),typeof e.dataset.tags<"u"&&(t.tags=e.dataset.tags.split(",")),typeof e.dataset.richTextConfig<"u"&&(t.richTextConfig=JSON.parse(e.dataset.richTextConfig)),t.singleMode=e.classList.contains("comment-viewer"),a.createApp(oe,t).use(b).mount(e)}),document.querySelectorAll(".comment-count:not([data-v-app])").forEach(e=>{const t={url:"",...e.dataset};a.createApp(se,t).mount(e)})}C(),new MutationObserver(C).observe(document,{childList:!0,subtree:!0})});
//# sourceMappingURL=osis-comment.umd.min.js.map
